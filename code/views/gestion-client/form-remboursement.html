<div class="content-header">
  <h1 id="page-title">Validation d’un remboursement</h1>
</div>

<div id="message" style="color: red; font-weight: bold;"></div>

<div style="margin-bottom: 20px;">
  <label>Client :</label>
  <select id="client-select">
    <option value="">-- Choisir un client --</option>
  </select>

  <label>Date prévue :</label>
  <input type="date" id="date-prevue" />

  <button id="chercher-btn">🔍 Chercher les prêts</button>
</div>

<div style="margin-top: 10px;">
  <label>Prêt :</label>
  <select id="pret-select">
    <option value="">-- Choisir un prêt --</option>
  </select>
</div>

<div id="details" style="display: none; margin-top: 20px; border: 1px solid #ccc; padding: 10px;">
  <p><strong>Assurance :</strong> <span id="assurance"></span></p>
  <p><strong>Amortissement :</strong> <span id="amortissement"></span></p>
  <p><strong>Intérêt :</strong> <span id="interet"></span></p>
  <p><strong>Pénalité :</strong> <span id="penalite"></span></p>
  <p><strong>Date prévue :</strong> <span id="datePrevueAff"></span></p>
  <h3><strong>Total à payer :</strong> <span id="total"></span></h3>

  <button id="valider-btn">💰 Valider le remboursement</button>
</div>

<script>
(() => {
  const apiBase = "http://localhost/S4/s4_final_exam/code/ws";

  function ajax(method, url, data, callback, errorCallback) {
    const xhr = new XMLHttpRequest();
    xhr.open(method, apiBase + url, true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) callback(JSON.parse(xhr.responseText));
        else if (errorCallback) errorCallback(xhr.responseText);
      }
    };
    xhr.send(data);
  }

  function afficherMessage(msg, color = "red") {
    const msgBox = document.getElementById("message");
    msgBox.style.color = color;
    msgBox.textContent = msg;
    setTimeout(() => msgBox.textContent = "", 4000);
  }

  function chargerClients() {
    ajax("GET", "/clients", null, (data) => {
      const select = document.getElementById("client-select");
      data.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = `${c.nom} ${c.prenom}`;
        select.appendChild(opt);
      });
    });
  }

  function chercherPrets() {
    const idClient = document.getElementById("client-select").value;
    const datePrevue = document.getElementById("date-prevue").value;
  
    if (!idClient || !datePrevue) {
      afficherMessage("Veuillez sélectionner un client et une date.");
      return;
    }
  
    const data = `id_client=${idClient}&date_prevue=${datePrevue}`;
  
    ajax("POST", "/remboursements/prets", data, (data) => {
      const select = document.getElementById("pret-select");
      select.innerHTML = `<option value="">-- Choisir un prêt --</option>`;
      data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `Prêt #${p.id} - Montant: ${p.montant}`;
        select.appendChild(opt);
      });
    });
  }
  

  function chargerDetailsRemboursement() {
    const idPret = document.getElementById("pret-select").value;
    const datePrevue = document.getElementById("date-prevue").value;
  
    if (!idPret || !datePrevue) return;
  
    const data = `id_pret=${idPret}&date_prevue=${datePrevue}`;
  
    ajax("POST", "/remboursements/details", data, (data) => {
      document.getElementById("assurance").textContent = data.assurance;
      document.getElementById("amortissement").textContent = data.amortissement;
      document.getElementById("interet").textContent = data.interet;
      document.getElementById("penalite").textContent = data.montant_penalite;
      document.getElementById("total").textContent = (
        data.assurance + data.amortissement + data.interet + data.montant_penalite
      ).toFixed(2);
      document.getElementById("datePrevueAff").textContent = datePrevue;
  
      document.getElementById("details").style.display = "block";
    }, () => {
      afficherMessage("Erreur lors du chargement des détails.");
    });
  }
  

  function validerRemboursement() {
    const idPret = document.getElementById("pret-select").value;
    const datePrevue = document.getElementById("date-prevue").value;
    const dateNow = new Date().toISOString().split("T")[0];

    if (!idPret || !datePrevue) {
      afficherMessage("Veuillez choisir un prêt et une date.");
      return;
    }

    const data = `id_pret=${idPret}&date_prevue=${datePrevue}&date_remboursement=${dateNow}`;
    ajax("POST", "/remboursements/valider", data, () => {
      afficherMessage("✅ Remboursement validé avec succès !", "green");
      document.getElementById("details").style.display = "none";
      document.getElementById("pret-select").innerHTML = `<option value="">-- Choisir un prêt --</option>`;
    }, () => {
      afficherMessage("❌ Erreur lors de la validation.");
    });
  }

  // Événements
  document.getElementById("chercher-btn").addEventListener("click", chercherPrets);
  document.getElementById("pret-select").addEventListener("change", chargerDetailsRemboursement);
  document.getElementById("valider-btn").addEventListener("click", validerRemboursement);

  // Initialisation
  chargerClients();
})();
</script>
